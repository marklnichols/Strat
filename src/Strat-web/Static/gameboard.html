<html>
<head> 
<meta charset="UTF-8"> 
<title>Gameboard</title>
<style type="text/css">
.gameboard { 
    width: 640px; 
    height: 640px; 
    margin: 20px; 
    border: 25px solid #333; 
}
.black { 
    float: left; 
    width: 80px;
    height: 80px; 
    background-color: #999; 
    font-size: 50px; 
    text-align:center; 
    display: table-cell; 
    vertical-align:middle;
}
.white { 
    float: left; 
    width: 80px;
    height: 80px; 
    background-color: #fff; 
    font-size: 50px; 
    text-align: center; 
    display: table-cell; 
    vertical-align:middle;
}

.selected { 
    background-color: #3c5a8c;
}

.dblclicked { 
    background-color: #42f4d1;
}

.processing { 
    background-color: #42f4d7;
}


.flash {

  -moz-animation: flash 1s ease-out;
  -moz-animation-iteration-count: 1;

  -webkit-animation: flash 1s ease-out;
  -webkit-animation-iteration-count: 1;

  -ms-animation: flash 1s ease-out;
  -ms-animation-iteration-count: 1;
}

</style>
</head>

<body>
<!--input type="text" onkeydown="keyFunction(event)"-->
<script src="jquery-3.1.1.min.js"></script>

<script> 


//function flash (anId){
//    $('#'+anId).addClass("processing");
//    
//    setTimeout( function(){
//        $('#'+anId).removeClass("processing");
//    }, 1000);	// Timeout must be the same length as the CSS3 transition or longer (or you'll mess up the transition)
//}

var game = { } ;

//column indexes 0-7 -> A-H, row indexes 1-8
function rowCol2Id(col, row) { 
    return String.fromCharCode(97 + col) + row.toString();
}

function locToId(aLoc) {
    var aCol = aLoc.col
    var aRow = aLoc.row
    var anId = aCol + aRow.toString()
    return anId
}

function idToRow(id) {
    return parseInt(id.charAt(1))
}

function idToCol(id) {
    return id.charAt(0)
}

function flashSelections (anId){
    for (var i = 0; i < game.selections.length; i++) { 
        var aLoc = game.selections[i]
        var anId = locToId(aLoc)
        $('#'+anId).addClass("processing");
    }
    setTimeout( function(){
        resetSelections()
    }, 1000);
}

function resetSelections() {
    for (var i = 0; i < game.selections.length; i++) { 
        var aLoc = game.selections[i]
        var anId = locToId(aLoc)
        $('#'+anId).removeClass("selected"); 
        $('#'+anId).removeClass("processing"); 
    }
    game.selections = new Array();
}

       
function selectSquare(id) { 
    $('#'+id).addClass("selected"); 
}

function pushLocation(id) {
    var c = idToCol(id)
    var r = idToRow(id)
    var new_loc = new loc(c, r)
    
    if ( !(isDuplicate(new_loc)) ) {
        game.selections.push(new_loc)
    }
}

function isDuplicate(new_loc) {
    var len = game.selections.length
    if (len == 0) {
        return false
    }
    var top = game.selections[len-1]
    if (JSON.stringify(top) === JSON.stringify(new_loc)) {
        return true
    } else {
        return false
    }
}

function loc(col, row) {
    this.col = col
    this.row = row
}

function move(locs) {
    this.locs = locs
}

function selectSquareDbl(id) { 
    $('#'+id).addClass("dblclicked"); 
    pushLocation(id)
}

function submitMove(id) {
    var new_move = new move(game.selections)
    if (checkValidMove(new_move)) {
        var json = JSON.stringify(new_move);
        flashSelections()
        $.ajax ({url: "http://localhost:3000/playerMove", method: "post", data: json, success: function(result) {
            setValidMoves(result.legalMoves);
            updateGameBoard(result.board);
        }})
    } else {
        alert ("Invalid move.");
        resetSelections()
   }
}


function checkValidMove(new_move) {
    var valid = game.validMoves.moves;
    for (var i = 0; i < valid.length; i++) { 
        var move = valid[i]
        if (compareMoves(move, new_move) == true) {
            return true
        }
    }
    return false
}

function compareMoves(m1, m2) {
    var l1 = m1.locs
    var l2 = m2.locs
    
    if (l1.length != l2.length) {
        return false
    }
    for (var j = 0; j < l1.length; j++) {
        if (compareLocs(l1[j], l2[j]) == false) {
            return false
        }
    }
    return true
 }
 
 function compareLocs(loc1, loc2) {
    if (loc1.col.toUpperCase() == loc2.col.toUpperCase() && loc1.row == loc2.row) {
        return true
    } else {
        return false
    }
 }
    

function onClick(event) {
    pushLocation(this.id)
    selectSquare(this.id);
}

function onDblClick(event) { 
    submitMove(this.id)
}


$(document).keydown(function(e) {
  if(e.which == 27) {
    //alert ("You pressed the Escape key!");
    resetSelections()
  }
});


$(document).ready(function() { 
    // attach mouse click handler to each div sqare 
    for (var i = 0; i < 8; i++) { 
        for (var j = 1; j < 9; j++) { 
            //build strings #a1 - #h8
            var id = rowCol2Id(i, j); 
            $('#'+id).click(onClick);
            $('#'+id).dblclick(onDblClick);
        }
    }
    game.selections = new Array();
    //get pieces...
    $.ajax ({url: "http://localhost:3000/new", success: function(result) {
        setValidMoves(result.legalMoves)
        updateGameBoard(result.board);
    }})
});

function setValidMoves(moves) {
    game.validMoves = moves;
}

function updateGameBoard(board) {
    var whitePieceChar = '\u26c0'
    var blackPieceChar = '\u26c2'
    var whitePieceKing = '\u26c1'
    var blackPieceKing = '\u26c3'
    
    // clear the board
    for (var i = 0; i < 8; i++) {
        for (var j = 1; j < 9; j++) {
            var id = rowCol2Id(i, j);
            $('#'+id).text("");
        }
    }   
    // set the pieces
    for (var i = 0; i < board.length; i++) {
        var e = $('#'+board[i].loc.col.toLowerCase()+board[i].loc.row);
        if (board[i].pieceType == 1) { //if regular piece
            $(e).text(board[i].color === 1 ? whitePieceChar : blackPieceChar);
        } else { //else piece is a king
            $(e).text(board[i].color === 1 ? whitePieceKing : blackPieceKing);
        }
    }
    //autoPlay()
}

//function autoPlay() {
    //$.ajax ({url: "http://localhost:3000/computerMove", success: function(result) {
    //    updateGameBoard(result);
    //}})
//}

</script>

<!-- div id="specificGame"></div-->

<div class="gameboard" >

<!-- 1st -->
<div id="a8" class="white"></div> 
<div id="b8" class="black"></div> 
<div id="c8" class="white"></div> 
<div id="d8" class="black"></div> 
<div id="e8" class="white"></div>
<div id="f8" class="black"></div>  
<div id="g8" class="white"></div> 
<div id="h8" class="black"></div> 
<!-- 2nd -->
<div id="a7" class="black"></div>  
<div id="b7" class="white"></div> 
<div id="c7" class="black"></div>  
<div id="d7" class="white"></div>
<div id="e7" class="black"></div> 
<div id="f7" class="white"></div> 
<div id="g7" class="black"></div> 
<div id="h7" class="white"></div>
<!-- 3rd -->
<div id="a6" class="white"></div> 
<div id="b6" class="black"></div> 
<div id="c6" class="white"></div> 
<div id="d6" class="black"></div> 
<div id="e6" class="white"></div> 
<div id="f6" class="black"></div> 
<div id="g6" class="white"></div> 
<div id="h6" class="black"></div> 
<!-- 4th -->
<div id="a5" class="black"></div> 
<div id="b5" class="white"></div>
<div id="c5" class="black"></div> 
<div id="d5" class="white"></div>
<div id="e5" class="black"></div> 
<div id="f5" class="white"></div>
<div id="g5" class="black"></div> 
<div id="h5" class="white"></div>
<!-- 5th -->
<div id="a4" class="white"></div> 
<div id="b4" class="black"></div> 
<div id="c4" class="white"></div> 
<div id="d4" class="black"></div> 
<div id="e4" class="white"></div> 
<div id="f4" class="black"></div> 
<div id="g4" class="white"></div> 
<div id="h4" class="black"></div> 
<!-- 6th -->
<div id="a3" class="black"></div> 
<div id="b3" class="white"></div> 
<div id="c3" class="black"></div> 
<div id="d3" class="white"></div> 
<div id="e3" class="black"></div>  
<div id="f3" class="white"></div> 
<div id="g3" class="black"></div>  
<div id="h3" class="white"></div> 
<!-- 7th -->
<div id="a2" class="white"></div>
<div id="b2" class="black"></div> 
<div id="c2" class="white"></div> 
<div id="d2" class="black"></div>  
<div id="e2" class="white"></div>
<div id="f2" class="black"></div>  
<div id="g2" class="white"></div> 
<div id="h2" class="black"></div> 
<!-- 8th -->
<div id="a1" class="black"></div> 
<div id="b1" class="white"></div> 
<div id="c1" class="black"></div>  
<div id="d1" class="white"></div> 
<div id="e1" class="black"></div> 
<div id="f1" class="white"></div> 
<div id="g1" class="black"></div> 
<div id="h1" class="white"></div>
</div>


</body>
</html>
